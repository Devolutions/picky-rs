name: CI

on:
  workflow_dispatch:

jobs:
  formatting:
    name: Check formatting
    runs-on: ubuntu-18.04

    steps:
      - uses: actions/checkout@v2

      - name: Check formatting
        shell: pwsh
        run: |
          Write-Host "Check formatting"
          cargo fmt --all -- --check

          if ($LastExitCode -eq 1) {   
            throw "Bad formatting, please run 'cargo +stable fmt --all'"
          }

  build:
    name: picky [${{ matrix.os }}]
    runs-on: ${{ matrix.runner }}
    needs: formatting
    env:
      CONAN_LOGIN_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
      CONAN_PASSWORD: ${{ secrets.ARTIFACTORY_READ_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        os: [ windows, linux ]
        include:
          - os: windows
            runner: windows-2019
          - os: linux
            runner: ubuntu-18.04
          
    steps:
      - uses: actions/checkout@v2

      - name: Configure runner
        if: matrix.os == 'linux'
        run: |
          sudo apt update
          sudo apt install python3-wget python3-setuptools

      - name: Install conan
        run: |
          pip3 install conan==1.40.0 invoke Jinja2 --upgrade

      - name: Configure conan
        run: |
          conan config install --type=git -sf settings https://github.com/Devolutions/conan-public
          conan remote clean
          conan remote add artifactory https://devolutions.jfrog.io/devolutions/api/conan/conan-local

      - name: Build
        if: matrix.os == 'linux'
        run: |
         conan install openssl/1.1.1l@devolutions/stable -g virtualenv -pr ${{ matrix.os }}-x86_64 -s build_type=Release
         . activate.sh
         cargo build --release

      - name: Build
        if: matrix.os == 'windows'
        env:
          RUSTFLAGS: '-C target-feature=+crt-static'
        run: |
         conan install openssl/1.1.1l@devolutions/stable -g virtualenv -pr ${{ matrix.os }}-x86_64 -s build_type=Release
         .\activate.ps1
         cargo build --release --target=x86_64-pc-windows-msvc

      - name: Test
        run: cargo test --release --features "wincert","ctl","pkcs7"

      - name: Prepare artifacts
        id: prepare-artifacts
        shell: pwsh
        run: |
          $StagingDir = Join-Path "$Env:RUNNER_TEMP" "picky" "${{runner.os}}" "x86_64"
          $Binaries = @("picky-server", "picky-signtool")
          
          if ($Env:RUNNER_OS -Eq "Windows") {
            $Binaries = $Binaries | ForEach-Object {"$_.exe"}
          }

          Get-ChildItem -Recurse -Include $Binaries -File  | % {
            Copy-Item -Path $_.FullName -Destination $StagingDir -Force 
          }

          echo "::set-output name=staging-dir::$StagingDir"

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: picky
          path: ${{ steps.prepare-artifacts.outputs.staging-dir }}





